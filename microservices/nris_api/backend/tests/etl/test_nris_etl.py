from app.nris.etl.nris_etl import etl_nris_data
from app.nris.models.inspection import Inspection
from app.nris.models.inspection_status import InspectionStatus
from app.nris.models.location import Location
from app.nris.models.inspected_location import InspectedLocation
from app.nris.models.order_request_detail import OrderRequestDetail
from app.nris.models.order_advisory_detail import OrderAdvisoryDetail
from app.nris.models.order_warning_detail import OrderWarningDetail
from app.nris.models.order_stop_detail import OrderStopDetail
from app.nris.models.inspected_location_type import InspectedLocationType
from app.nris.models.noncompliance_legislation import NonComplianceLegislation
from app.nris.models.noncompliance_permit import NonCompliancePermit
from app.nris.models.legislation_act import LegislationAct
from app.nris.models.legislation_act_section import LegislationActSection
from app.nris.models.legislation_compliance_article import LegislationComplianceArticle
from app.nris.models.document import Document
from app.nris.models.document_type import DocumentType
from app.nris.models.nris_raw_data import NRISRawData
from app.nris.models.inspection_type import InspectionType

nris_data = """<?xml version="1.0" encoding="UTF-8"?><caeAssessment xmlns="http://www.ccvs.com"><assessment_id>11111</assessment_id><assessment_type>INSPECTION</assessment_type><assessment_sub_type>Inspection</assessment_sub_type><assessment_date>2018-01-16T08:00:00.000-08:00</assessment_date><assessment_status>Complete</assessment_status><assessment_sub_status>Closed</assessment_sub_status><businessArea><business_area_name>EMPR</business_area_name></businessArea><regionGroup><region>Southeast</region></regionGroup><reason>Planned</reason><authorization><source_id>Q-5-130</source_id><source_application>MMS</source_application><auth_status>Approved</auth_status><auth_type>QUARRY</auth_type></authorization><client><org_name>My Organization (Awesome) Ltd.</org_name><client_telephone_number>(111) 111 1111</client_telephone_number><fax_number>(111) 111 1111</fax_number><client_email_address /><address>Suite 111 1111-1st Street SE Calgary AB A1A 1A1</address><client_number>111111</client_number><client_source_application>MMS</client_source_application></client><contacts><contact_first_name>Bill</contact_first_name><contact_last_name>Billy</contact_last_name><contact_type>Manager</contact_type><contact_job_title>Mine Manager</contact_job_title><contact_company_name>My Organization</contact_company_name><contact_legal_address>1111 Gravy River A Purple, BC A1A 1A1</contact_legal_address><contact_phone_numbers>111-111-1111</contact_phone_numbers></contacts><attendance><attendance_first_name>Bill</attendance_first_name><attendance_last_name>Billy</attendance_last_name><org>My Organization</org><attendance_type>Management</attendance_type><attendance_title>Mine Manager</attendance_title></attendance><attendance><attendance_first_name>Jen</attendance_first_name><attendance_last_name>Jenny</attendance_last_name><org>My Organization</org><attendance_type>Management</attendance_type><attendance_title>Safety</attendance_title></attendance><attendance><attendance_first_name>Kate</attendance_first_name><attendance_last_name>Katey</attendance_last_name><org>My Organization</org><attendance_type>Occupational Health &amp; Safety Committee</attendance_type><attendance_title>JOHSC REP</attendance_title></attendance><location><location_name>My Origanization Mine</location_name><location_id>1111111</location_id><latitude>00.00000</latitude><longitude>-000.00000</longitude><location_description>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</location_description><location_activity>IS. INDUSTRIAL MINERALS - SURFACE</location_activity><location_utm_easting>111111.0</location_utm_easting><location_utm_northing>1111111.0</location_utm_northing><location_utm_zone_number>11.0</location_utm_zone_number><location_utm_zone_letter>U</location_utm_zone_letter><location_status>Active</location_status><location_type>true</location_type></location><attachment><attachment_id>111111</attachment_id><file_path>EMPR_InspectionReport_11111.docx</file_path><file_type>Report</file_type><attachment_comment>INSPECTION Report</attachment_comment><attachment_date>2018-01-19T09:59:00.000-08:00</attachment_date><attachment_media_type>application/vnd.openxmlformats-officedocument.wordprocessingml.document</attachment_media_type></attachment><attachment><attachment_id>111111</attachment_id><file_path>EMPR_InspectionReport_11111 - with Mine Manager response.pdf</file_path><file_type>Mine ManagerResponse</file_type><attachment_comment>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</attachment_comment><attachment_date>2018-02-05T08:06:00.000-08:00</attachment_date><attachment_media_type>application/pdf</attachment_media_type><size>1111111</size></attachment><assessor>IDIR\\AAAAAAAA</assessor><report_introduction>&lt;p&gt;Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.&lt;/p&gt;</report_introduction><report_preamble>&lt;p&gt;Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.&lt;/p&gt;</report_preamble><inspection><stops><stop_type>stop</stop_type><secondary_locations><secondary_location_description>Excepteur sint occaecat cupidatat non proident</secondary_location_description><secondary_location_notes /><secondary_location_utm /></secondary_locations><stop_orders><order_type>Inspection Mines</order_type><order_response_status>Accepted</order_response_status><order_status>Closed</order_status><order_observation>Sed turpis tincidunt id aliquet risus feugiat in ante. Ac placerat vestibulum lectus mauris ultrices eros. Quis varius quam quisque id diam vel quam elementum. Nam aliquam sem et tortor. Penatibus et magnis dis parturient. Sed risus ultricies tristique nulla aliquet enim tortor at. Rhoncus est pellentesque elit ullamcorper dignissim.</order_observation><order_detail>Purus viverra accumsan in nisl nisi. Dictumst vestibulum rhoncus est pellentesque elit ullamcorper dignissim cras.</order_detail><order_response>Turpis cursus in hac habitasse platea dictumst quisque.</order_response><order_completion_date>2019-07-03T12:46:00.000-07:00</order_completion_date><order_response_received_date>2018-01-29T00:00:00.000-08:00</order_response_received_date><order_legislations><estimated_incident_date>2018-01-16-08:00</estimated_incident_date><parent_act>Mines Act (293/1996)</parent_act><act_regulation>Health, Safety and Reclamation Code for Mines in BC (MA)</act_regulation><section>4.1.1</section><noncompliant_description>Design and Construction</noncompliant_description><compliance_article_id>9901</compliance_article_id><compliance_article_comments>(1) All buildings shall be constructed in accordance with the British Columbia Building Code. ...</compliance_article_comments></order_legislations><order_authority_act>Mines Act</order_authority_act><order_authority_section>Section 15(4)</order_authority_section><attachment><attachment_id>111111</attachment_id><file_path>111.JPG</file_path><file_type>Image</file_type><attachment_comment>Turpis cursus in hac habitasse platea dictumst quisque.</attachment_comment><attachment_date>2018-01-19T08:41:00.000-08:00</attachment_date><attachment_media_type>image/jpeg</attachment_media_type><size>623410</size></attachment></stop_orders><stop_orders><order_type>Inspection Mines</order_type><order_response_status>Accepted</order_response_status><order_status>Closed</order_status><order_observation>Integer vitae justo eget magna fermentum iaculis eu. Turpis egestas sed tempus urna et pharetra.</order_observation><order_detail>Neque viverra justo nec ultrices dui sapien eget.</order_detail><order_response>Varius sit amet mattis vulputate enim. Tellus pellentesque eu tincidunt tortor aliquam nulla. Ullamcorper a lacus vestibulum sed. Tempor nec feugiat nisl pretium fusce id velit. Viverra nibh cras pulvinar mattis nunc sed blandit libero. Nec ultrices dui sapien eget mi proin sed libero enim. Arcu bibendum at varius vel pharetra vel.</order_response><order_completion_date>2019-07-03T12:46:00.000-07:00</order_completion_date><order_response_received_date>2018-01-29T00:00:00.000-08:00</order_response_received_date><order_legislations><estimated_incident_date>2018-01-16-08:00</estimated_incident_date><parent_act>Mines Act (293/1996)</parent_act><act_regulation>Health, Safety and Reclamation Code for Mines in BC (MA)</act_regulation><section>4.1.1</section><noncompliant_description>Design and Construction</noncompliant_description><compliance_article_id>9901</compliance_article_id><compliance_article_comments>(1) All buildings shall be constructed in accordance with the British Columbia Building Code. ...</compliance_article_comments></order_legislations><order_authority_act>Mines Act</order_authority_act><order_authority_section>Section 15(4)</order_authority_section><attachment><attachment_id>111111</attachment_id><file_path>111.JPG</file_path><file_type>Image</file_type><attachment_comment>Neque viverra justo nec ultrices dui sapien eget.</attachment_comment><attachment_date>2018-01-19T08:41:00.000-08:00</attachment_date><attachment_media_type>image/jpeg</attachment_media_type><size>579824</size></attachment></stop_orders><stop_orders><order_type>Inspection Mines</order_type><order_response_status>Accepted</order_response_status><order_status>Closed</order_status><order_observation>Euismod quis viverra nibh cras pulvinar mattis nunc. Vitae justo eget magna fermentum iaculis eu non. Et tortor at risus viverra. Massa sapien faucibus et molestie. Eget velit aliquet sagittis id consectetur purus. Tellus in metus vulputate eu scelerisque felis imperdiet proin fermentum.</order_observation><order_detail>Sapien faucibus et molestie ac. Ligula ullamcorper malesuada proin libero nunc consequat interdum.</order_detail><order_response>Suscipit adipiscing bibendum est ultricies integer quis. Gravida neque convallis a cras semper auctor neque. Sapien faucibus et molestie ac. Ligula ullamcorper malesuada proin libero nunc consequat interdum.</order_response><order_completion_date>2019-07-03T12:46:00.000-07:00</order_completion_date><order_response_received_date>2018-01-29T09:01:00.000-08:00</order_response_received_date><order_legislations><estimated_incident_date>2018-01-16-08:00</estimated_incident_date><parent_act>Mines Act (293/1996)</parent_act><act_regulation>Health, Safety and Reclamation Code for Mines in BC (MA)</act_regulation><section>1.9.1</section><noncompliant_description>General</noncompliant_description><compliance_article_id>9732</compliance_article_id><compliance_article_comments>The manager shall (1) take all reasonable and practicable measures to ensure thatthe workplace is free of potentially hazardous agents and conditions which could adversely affect the health, safety, or well-being of the workers,</compliance_article_comments></order_legislations><order_authority_act>Mines Act</order_authority_act><order_authority_section>Section 15(4)</order_authority_section><attachment><attachment_id>111111</attachment_id><file_path>111.JPG</file_path><file_type>Image</file_type><attachment_comment>Ligula ullamcorper malesuada proin libero nunc consequat interdum.</attachment_comment><attachment_date>2018-01-19T08:56:00.000-08:00</attachment_date><attachment_media_type>image/jpeg</attachment_media_type><size>1111111</size></attachment></stop_orders><stop_orders><order_type>Inspection Mines</order_type><order_response_status>Received</order_response_status><order_status>Closed</order_status><order_observation>Tellus in metus vulputate eu scelerisque felis imperdiet proin fermentum. Cras semper auctor neque vitae tempus quam pellentesque. Suscipit adipiscing bibendum est ultricies integer quis. Gravida neque convallis a cras semper auctor neque. Sapien faucibus et molestie ac. Ligula ullamcorper malesuada proin libero nunc consequat interdum.</order_observation><order_detail>Tellus in metus vulputate eu scelerisque felis imperdiet proin fermentum. Cras semper auctor neque vitae tempus quam pellentesque. Suscipit adipiscing bibendum est ultricies integer quis. Gravida neque convallis a cras semper auctor neque. Sapien faucibus et molestie ac. Ligula ullamcorper malesuada proin libero nunc consequat interdum.</order_detail><order_response>Aenean et tortor at risus viverra adipiscing at. Sollicitudin tempor id eu nisl. Mauris pellentesque pulvinar pellentesque habitant morbi tristique senectus. Eu lobortis elementum nibh tellus molestie nunc non blandit. Nibh mauris cursus mattis molestie a iaculis. Aliquam id diam maecenas ultricies.</order_response><order_completion_date>2019-07-03T12:46:00.000-07:00</order_completion_date><order_response_received_date>2018-01-29T09:03:00.000-08:00</order_response_received_date><order_legislations><estimated_incident_date>2018-01-16-08:00</estimated_incident_date><parent_act>Mines Act (293/1996)</parent_act><act_regulation>Health, Safety and Reclamation Code for Mines in BC (MA)</act_regulation><section>3.7.1</section><noncompliant_description>Mine Emergency Response Plan</noncompliant_description><compliance_article_id>9866</compliance_article_id><compliance_article_comments>(1) The manager shall develop, and file with the chief inspector, a Mine Emergency Response Plan (MERP), which shall be kept up to date and followed in the event of an emergency.</compliance_article_comments></order_legislations><order_authority_act>Mines Act</order_authority_act><order_authority_section>Section 15(4)</order_authority_section><attachment><attachment_id>111111</attachment_id><file_path>111.JPG</file_path><file_type>Image</file_type><attachment_comment>Ligula ullamcorper malesuada proin libero nunc consequat interdum.</attachment_comment><attachment_date>2018-01-19T09:20:00.000-08:00</attachment_date><attachment_media_type>image/jpeg</attachment_media_type><size>553480</size></attachment></stop_orders></stops><inspection_type>Health and Safety</inspection_type><inspection_type>Mechanical</inspection_type><inspct_from_date>2018-01-16T08:00:00.000-08:00</inspct_from_date><inspct_report_sent_date>2018-01-19T00:00:00.000-08:00</inspct_report_sent_date><related_Inspctrs><attendance_first_name>Kris</attendance_first_name><attendance_last_name>Krissy</attendance_last_name><attendance_type>Inspector</attendance_type><attendance_title>Inspector of Mines</attendance_title></related_Inspctrs><inspection_sub_type>Mine Inspection</inspection_sub_type></inspection><completion_date>2018-02-05T08:09:00.000-08:00</completion_date></caeAssessment>"""


def test_etl_nris_data(session):
    data = NRISRawData.create(nris_data)
    session.add(data)
    etl_nris_data()

    assert len(session.query(Inspection).all()) is 1
    assert len(session.query(InspectionStatus).all()) is 1
    assert len(session.query(Location).all()) is 1
    assert len(session.query(InspectedLocation).all()) is 1
    assert len(session.query(OrderRequestDetail).all()) is 0
    assert len(session.query(OrderAdvisoryDetail).all()) is 0
    assert len(session.query(OrderWarningDetail).all()) is 0
    assert len(session.query(OrderStopDetail).all()) is 4
    assert len(session.query(InspectedLocationType).all()) is 1
    assert len(session.query(NonComplianceLegislation).all()) is 4
    assert len(session.query(NonCompliancePermit).all()) is 0
    assert len(session.query(LegislationAct).all()) is 2
    assert len(session.query(LegislationActSection).all()) is 3
    assert len(session.query(LegislationComplianceArticle).all()) is 3
    assert len(session.query(Document).all()) is 6
    assert len(session.query(DocumentType).all()) is 3
    assert len(session.query(NRISRawData).all()) is 1
    assert len(session.query(InspectionType).all()) is 1


def test_data_does_not_persist(session):
    assert len(session.query(Inspection).all()) is 0
    assert len(session.query(InspectionStatus).all()) is 0
    assert len(session.query(Location).all()) is 0
    assert len(session.query(InspectedLocation).all()) is 0
    assert len(session.query(OrderRequestDetail).all()) is 0
    assert len(session.query(OrderAdvisoryDetail).all()) is 0
    assert len(session.query(OrderWarningDetail).all()) is 0
    assert len(session.query(OrderStopDetail).all()) is 0
    assert len(session.query(InspectedLocationType).all()) is 0
    assert len(session.query(NonComplianceLegislation).all()) is 0
    assert len(session.query(NonCompliancePermit).all()) is 0
    assert len(session.query(LegislationAct).all()) is 0
    assert len(session.query(LegislationActSection).all()) is 0
    assert len(session.query(LegislationComplianceArticle).all()) is 0
    assert len(session.query(Document).all()) is 0
    assert len(session.query(DocumentType).all()) is 0
    assert len(session.query(NRISRawData).all()) is 0
    assert len(session.query(InspectionType).all()) is 0
